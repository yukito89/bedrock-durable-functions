# 認証方式の比較と採用理由

## 検討した認証方式の比較表

| 認証方式 | 実装場所 | コスト | 実装難易度 | セキュリティレベル | 採用可否 | 理由 |
|---------|---------|--------|-----------|------------------|---------|------|
| **Azure Functions 関数キー** | バックエンド | 無料 | 低 | 中 | ❌ 不採用 | IP制限に変更したため不要 |
| **Azure Functions IP制限** | バックエンド | 無料 | 低 | 高 | ✅ 採用 | ネットワークレベルで保護、設定が簡単 |
| **JavaScript パスワード認証** | フロントエンド | 無料 | 低 | 低〜中 | ✅ 採用 | 一般ユーザーへの簡易的な保護 |
| **Entra ID (Azure AD)** | フロントエンド | 無料〜有料 | 高 | 高 | ❌ 不採用 | 社内で提供されていない |
| **Azure Static Web Apps 組み込み認証** | フロントエンド | 無料 | 中 | 中 | ❌ 不採用 | 招待制のため不特定多数に不向き |
| **Cloudflare Access** | フロントエンド | 無料枠あり | 中 | 高 | ❌ 不採用 | 外部サービス依存、設定が複雑 |
| **Azure Front Door + WAF** | フロントエンド | 有料 | 高 | 高 | ❌ 不採用 | コストが高い（月額数千円） |
| **Basic認証（HTTPヘッダー）** | フロントエンド | 無料 | 中 | 中 | ❌ 不採用 | Azure Static Web Appsで標準サポートなし |

---

## 採用した認証構成

### 二重保護アーキテクチャ

```
ユーザー
  ↓
[1] JavaScript パスワード認証 (フロントエンド)
  ↓
Azure Static Web Apps
  ↓
[2] IP制限 (バックエンド)
  ↓
Azure Functions
  ↓
AWS Bedrock / Azure OpenAI
```

---

## 採用した認証方式の詳細

### 1. JavaScript パスワード認証（フロントエンド）

**実装内容:**
- `auth.js`でパスワード入力プロンプトを表示
- 正解するまで繰り返し入力を要求
- JavaScript無効化対策として`<noscript>`タグでコンテンツを非表示

**メリット:**
- ✅ 完全無料
- ✅ 実装が簡単（数行のコード）
- ✅ 一般ユーザーには十分な保護
- ✅ `prompt()`の同期処理により、DevToolsでも簡単には回避できない
- ✅ JavaScript無効化対策済み

**デメリット:**
- ❌ 技術的に詳しい人は回避可能（ブラウザ拡張機能、プロキシツールなど）
- ❌ パスワードがソースコードに記載される
- ❌ ユーザー管理機能なし

**採用理由:**
- 社内検証用のため、簡易的な保護で十分
- バックエンドのIP制限が本当の防御層
- コストゼロで即座に実装可能

---

### 2. Azure Functions IP制限（バックエンド）

**実装内容:**
- Azure Functionsの「ネットワーク」設定でIP制限を追加
- 許可IP: `159.28.124.242/32`
- 認証レベル: `ANONYMOUS`（IP制限に依存）

**メリット:**
- ✅ 完全無料
- ✅ ネットワークレベルで保護（最も強固）
- ✅ 設定が簡単（Azureポータルで数クリック）
- ✅ フロントエンド認証を回避されても、APIは使えない
- ✅ コード変更不要

**デメリット:**
- ❌ 固定IPアドレスが必要
- ❌ 社外からのアクセスは不可
- ❌ IP変更時に設定更新が必要

**採用理由:**
- 社内ネットワークからのみアクセスする想定
- 最も強固なセキュリティ保護
- 関数キー認証が不要になり、管理が簡素化

---

## 不採用となった認証方式の詳細

### Azure Functions 関数キー認証

**不採用理由:**
- IP制限を導入したため、関数キーは冗長
- キー管理の手間が増える
- フロントエンドにキーを埋め込むとソースコードで見える

---

### Entra ID (Azure AD) 認証

**不採用理由:**
- 社内で提供されていない
- 設定が複雑（アプリ登録、権限設定など）
- 社内検証用には過剰なセキュリティ

---

### Cloudflare Access

**不採用理由:**
- 外部サービスへの依存
- Cloudflareアカウントの作成・管理が必要
- 設定が複雑（DNS変更、プロキシ設定など）

---

### Azure Front Door + WAF

**不採用理由:**
- 月額数千円のコストが発生
- 社内検証用には過剰
- 設定が複雑

---

## セキュリティ評価

### 現在の構成のセキュリティレベル

| 攻撃シナリオ | 防御可否 | 理由 |
|------------|---------|------|
| 一般ユーザーがURLを知っている | ✅ 防御可能 | パスワード認証で保護 |
| 技術者がフロントエンド認証を回避 | ✅ 防御可能 | バックエンドのIP制限で保護 |
| 社外ネットワークからのアクセス | ✅ 防御可能 | IP制限で拒否 |
| 許可IPからの総当たり攻撃 | ⚠️ 一部脆弱 | パスワードが簡単な場合は突破可能 |
| DDoS攻撃 | ✅ 防御可能 | IP制限により攻撃元を限定 |

---

## 推奨事項

### 現在の構成で十分なケース
- ✅ 社内検証・PoC環境
- ✅ 固定IPからのアクセスのみ
- ✅ 機密性が中程度のデータ

### より強固な認証が必要なケース
- ❌ 本番環境での運用
- ❌ 社外からのアクセスが必要
- ❌ 個人情報や機密データを扱う

**その場合の推奨:**
- Entra ID (Azure AD) 認証の導入
- または、バックエンドでのトークンベース認証（JWT）

---

## まとめ

**採用した認証構成:**
- **フロントエンド**: JavaScript パスワード認証（簡易的な保護）
- **バックエンド**: Azure Functions IP制限（本当の防御層）

**採用理由:**
- 完全無料
- 実装が簡単
- 社内検証用として十分なセキュリティレベル
- 二重保護により、片方を突破されても安全

**結論:**
社内検証用途としては、コスト・実装難易度・セキュリティのバランスが最適な構成です。
